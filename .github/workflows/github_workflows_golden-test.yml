name: PRISM Phase 0.8 Golden File Regression Test

# GPT ê¶Œì¥: "Golden File + íšŒê·€ í…ŒìŠ¤íŠ¸ë¥¼ CIì— ë¶™ì—¬ì„œ íšŒê·€ ê¹¨ì§€ë©´ ë¹Œë“œ ì‹¤íŒ¨"

on:
  push:
    branches: [ main, develop, phase-0.8 ]
  pull_request:
    branches: [ main, develop ]
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

jobs:
  golden-regression-test:
    runs-on: ubuntu-latest
    
    steps:
    # 1. ì²´í¬ì•„ì›ƒ
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    # 2. Python ì„¤ì •
    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    # 3. ì˜ì¡´ì„± ì„¤ì¹˜
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # 4. Tesseract OCR ì„¤ì¹˜ (PDF ì²˜ë¦¬ìš©)
    - name: ğŸ“ Install Tesseract OCR
      run: |
        sudo apt-get update
        sudo apt-get install -y tesseract-ocr tesseract-ocr-kor
    
    # 5. Golden File íšŒê·€ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    - name: ğŸ”¬ Run Golden File Regression Tests
      run: |
        python tests/example_golden_usage.py regression
    
    # 6. í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
    - name: ğŸ“Š Upload test reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: golden-diff-reports
        path: tests/golden/**/*_diff_report.json
    
    # 7. ì‹¤íŒ¨ ì‹œ ìŠ¬ë™ ì•Œë¦¼ (ì˜µì…˜)
    - name: ğŸ“¢ Slack notification on failure
      if: failure()
      uses: slackapi/slack-github-action@v1
      with:
        webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
        payload: |
          {
            "text": "ğŸš¨ PRISM Golden File Regression Test FAILED",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Golden File Regression Test Failed*\n\nBranch: `${{ github.ref }}`\nCommit: `${{ github.sha }}`\nAuthor: ${{ github.actor }}\n\n<${{ github.event.head_commit.url }}|View Commit>"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # Job 2: ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ (ì˜µì…˜)
  performance-benchmark:
    runs-on: ubuntu-latest
    needs: golden-regression-test
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: âš¡ Run performance benchmark
      run: |
        python tests/benchmark_golden.py
    
    - name: ğŸ“Š Upload benchmark results
      uses: actions/upload-artifact@v3
      with:
        name: performance-benchmark
        path: tests/benchmark_results.json
