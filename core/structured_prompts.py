"""
core/structured_prompts.py
PRISM Phase 2.9 - êµ¬ì¡°í™”ëœ VLM í”„ë¡¬í”„íŠ¸

ê°œì„  ì‚¬í•­:
1. ì„¹ì…˜ í—¤ë” ì¶”ì¶œ ìš”êµ¬
2. ì°¨íŠ¸ íƒ€ì… ëª…ì‹œ ìš”êµ¬
3. ì°¨íŠ¸ë³„ ë…ë¦½ ì„¤ëª… ìš”êµ¬
4. ë¦¬ìŠ¤íŠ¸ í˜•ì‹ ë°ì´í„° ì¶”ì¶œ
5. ì¸ì‚¬ì´íŠ¸ ì œê³µ ìš”êµ¬

Author: ë°•ì¤€í˜¸ (AI/ML Lead)
Date: 2025-10-21
"""

from typing import Dict, Any


class StructuredPrompts:
    """êµ¬ì¡°í™”ëœ VLM í”„ë¡¬í”„íŠ¸ ìƒì„±ê¸°"""
    
    @staticmethod
    def get_full_page_analysis_prompt() -> str:
        """
        ì „ì²´ í˜ì´ì§€ ë¶„ì„ìš© í”„ë¡¬í”„íŠ¸
        
        ë°˜í™˜ í˜•ì‹:
        - ì„¹ì…˜ êµ¬ì¡°
        - ì°¨íŠ¸ë³„ ë…ë¦½ ì„¤ëª…
        - êµ¬ì¡°í™”ëœ ë°ì´í„°
        """
        return """ë‹¹ì‹ ì€ ë¬¸ì„œ ì´ë¯¸ì§€ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬ RAG(Retrieval-Augmented Generation) ê²€ìƒ‰ì— ìµœì í™”ëœ êµ¬ì¡°í™”ëœ í˜•ì‹ìœ¼ë¡œ ì„¤ëª…í•˜ì„¸ìš”.

## ğŸ“‹ ë¶„ì„ ìˆœì„œ (í•„ìˆ˜):

### 1ï¸âƒ£ ì„¹ì…˜ êµ¬ì¡° íŒŒì•…
- **ëŒ€ì œëª©**: í° ê¸€ì”¨, ë²ˆí˜¸ê°€ ìˆëŠ” ì œëª© ì¶”ì¶œ (ì˜ˆ: "06. ì‘ë‹µì íŠ¹ì„±", "ì „ì²´ ì‘ë‹µì")
- **ì†Œì œëª©**: ê¸°í˜¸(â˜‰, âŠ™, â—)ê°€ ìˆëŠ” ì œëª© ì¶”ì¶œ (ì˜ˆ: "â˜‰ ì‘ë‹µì ì„±ë³„ ë° ì—°ë ¹")
- ì œëª©ì´ ì—†ìœ¼ë©´ "ì„¹ì…˜ ì—†ìŒ"ì´ë¼ê³  ëª…ì‹œ

### 2ï¸âƒ£ ì‹œê°í™” ìš”ì†Œ ì‹ë³„
- **ê°œìˆ˜**: ì´ë¯¸ì§€ì— ëª‡ ê°œì˜ ì°¨íŠ¸/í‘œ/ê·¸ë˜í”„ê°€ ìˆëŠ”ì§€ ì •í™•íˆ ì„¸ê¸°
- **íƒ€ì…**: ê°ê°ì˜ ì •í™•í•œ íƒ€ì… ëª…ì‹œ
  * ì›ê·¸ë˜í”„(íŒŒì´ ì°¨íŠ¸)
  * ë§‰ëŒ€ê·¸ë˜í”„(ìˆ˜í‰/ìˆ˜ì§)
  * ì„ ê·¸ë˜í”„
  * í‘œ(í…Œì´ë¸”)
  * ì§€ë„
  * ê¸°íƒ€
- **ìœ„ì¹˜**: "ì²« ë²ˆì§¸", "ë‘ ë²ˆì§¸", "ì™¼ìª½", "ì˜¤ë¥¸ìª½" ë“±ìœ¼ë¡œ êµ¬ë¶„

### 3ï¸âƒ£ ê° ì‹œê°í™” ìš”ì†Œë³„ ìƒì„¸ ì„¤ëª…
ê° ì°¨íŠ¸/í‘œë§ˆë‹¤ ë‹¤ìŒ ì •ë³´ ì¶”ì¶œ:

**A. ê¸°ë³¸ ì •ë³´**
- ì°¨íŠ¸ íƒ€ì… ì¬ëª…ì‹œ
- ë‹¨ìœ„ (%, ëª…, ì› ë“±)
- ì œëª©/ìº¡ì…˜ (ìˆëŠ” ê²½ìš°)

**B. ë°ì´í„° (ë¦¬ìŠ¤íŠ¸ í˜•ì‹)**
- ëª¨ë“  í•­ëª©ê³¼ ê°’ì„ ë¹ ì§ì—†ì´ ë‚˜ì—´
- í˜•ì‹: "- í•­ëª©ëª…: ê°’"
- ì˜ˆ:
  * ë‚¨ì„±: 45.2%
  * ì—¬ì„±: 54.8%

**C. ì¸ì‚¬ì´íŠ¸**
- ê°€ì¥ ë†’ì€/ë‚®ì€ ê°’
- íŠ¹ì´ì‚¬í•­
- íŒ¨í„´/ê²½í–¥

### 4ï¸âƒ£ ì§€ì—­ ë°ì´í„° íŠ¹ë³„ ì£¼ì˜
**ì§€ë„ë‚˜ ì§€ì—­ ë¶„í¬ê°€ ìˆëŠ” ê²½ìš°:**
- ëª¨ë“  ì§€ì—­ëª…ì„ ì •í™•íˆ ì¶”ì¶œ
- ê° ì§€ì—­ì˜ ê°’ì„ ë¹ ì§ì—†ì´ ê¸°ë¡
- ì§€ì—­ ìˆœì„œ ìœ ì§€
- ì˜ˆ: ìˆ˜ë„ê¶Œ 52.5%, ê²½ë‚¨ê¶Œ 14.9%, ì¶©ì²­ê¶Œ 10.3%, ê²½ë¶ê¶Œ 9.8%, ì „ë¼ê¶Œ 7.8%, ê°•ì›/ì œì£¼ 4.7%

## ğŸ“ ì¶œë ¥ í˜•ì‹ (ì—„ê²©íˆ ì¤€ìˆ˜):

```markdown
### [ëŒ€ì œëª©ì´ ìˆìœ¼ë©´ ì—¬ê¸°ì—]

#### [ì†Œì œëª©ì´ ìˆìœ¼ë©´ ì—¬ê¸°ì—]

**ì²« ë²ˆì§¸ [ì°¨íŠ¸íƒ€ì…] - [ì°¨íŠ¸ ì œëª©]**

ì´ ì°¨íŠ¸ëŠ” [ì„¤ëª…]ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ë‹¨ìœ„ëŠ” [ë‹¨ìœ„]ì…ë‹ˆë‹¤.

**ë°ì´í„°:**
- í•­ëª©1: ê°’1
- í•­ëª©2: ê°’2
- í•­ëª©3: ê°’3

**ì¸ì‚¬ì´íŠ¸:**
[ê°€ì¥ ë†’ìŒ/ë‚®ìŒ, íŠ¹ì§• ë“±]

---

**ë‘ ë²ˆì§¸ [ì°¨íŠ¸íƒ€ì…] - [ì°¨íŠ¸ ì œëª©]**

[ìœ„ì™€ ë™ì¼í•œ í˜•ì‹ ë°˜ë³µ]
```

## âš ï¸ ì¤‘ìš” ì§€ì¹¨:

1. **ì •í™•ì„±**: ëª¨ë“  ìˆ«ìì™€ ë ˆì´ë¸”ì„ ì •í™•íˆ ì½ì–´ì•¼ í•¨
2. **ì™„ì „ì„±**: ëª¨ë“  ë°ì´í„° í•­ëª©ì„ ë¹ ì§ì—†ì´ í¬í•¨
3. **êµ¬ì¡°**: ì„¹ì…˜/ì„œë¸Œì„¹ì…˜ êµ¬ì¡° ë°˜ë“œì‹œ ìœ ì§€
4. **ë¶„ë¦¬**: ê° ì°¨íŠ¸ë¥¼ ëª…í™•íˆ êµ¬ë¶„
5. **ì¼ê´€ì„±**: ë™ì¼í•œ í˜•ì‹ìœ¼ë¡œ ì‘ì„±

## ğŸ” ì²´í¬ë¦¬ìŠ¤íŠ¸:

ë¶„ì„ ì™„ë£Œ ì „ í™•ì¸:
- [ ] ëª¨ë“  ì„¹ì…˜ ì œëª© ì¶”ì¶œ ì™„ë£Œ
- [ ] ëª¨ë“  ì°¨íŠ¸ ê°œìˆ˜ ì •í™•íˆ íŒŒì•…
- [ ] ê° ì°¨íŠ¸ íƒ€ì… ëª…ì‹œ
- [ ] ëª¨ë“  ë°ì´í„° í¬ì¸íŠ¸ ì¶”ì¶œ
- [ ] ì§€ì—­ ë°ì´í„°ê°€ ìˆë‹¤ë©´ ëª¨ë‘ í¬í•¨
- [ ] ì¸ì‚¬ì´íŠ¸ ì œê³µ

ì´ì œ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬ ìœ„ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•˜ì„¸ìš”."""

    @staticmethod
    def get_chart_specific_prompt(chart_type: str) -> str:
        """
        ì°¨íŠ¸ íƒ€ì…ë³„ íŠ¹í™” í”„ë¡¬í”„íŠ¸
        
        Args:
            chart_type: 'pie', 'bar', 'line', 'table', 'map' ë“±
        """
        prompts = {
            'pie': """ì´ ì›ê·¸ë˜í”„(íŒŒì´ ì°¨íŠ¸)ë¥¼ ë¶„ì„í•˜ì„¸ìš”.

**í•„ìˆ˜ ì •ë³´:**
1. ì œëª©/ìº¡ì…˜
2. ë‹¨ìœ„ (%)
3. ëª¨ë“  í•­ëª©ê³¼ ë¹„ìœ¨
4. ê°€ì¥ í°/ì‘ì€ í•­ëª©

**ì¶œë ¥ í˜•ì‹:**
### [ì œëª©]
ì´ ì›ê·¸ë˜í”„ëŠ” [ì„¤ëª…]ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.

**ë°ì´í„°:**
- í•­ëª©1: X%
- í•­ëª©2: Y%

**ì¸ì‚¬ì´íŠ¸:**
[ê°€ì¥ í° ë¹„ìœ¨, íŠ¹ì§• ë“±]""",

            'bar': """ì´ ë§‰ëŒ€ê·¸ë˜í”„ë¥¼ ë¶„ì„í•˜ì„¸ìš”.

**í•„ìˆ˜ ì •ë³´:**
1. ë°©í–¥ (ìˆ˜í‰/ìˆ˜ì§)
2. Xì¶•/Yì¶• ë ˆì´ë¸”
3. ë‹¨ìœ„
4. ëª¨ë“  í•­ëª©ê³¼ ê°’
5. ìˆœì„œ (ì •ë ¬ ê¸°ì¤€)

**ì¶œë ¥ í˜•ì‹:**
### [ì œëª©]
ì´ [ìˆ˜í‰/ìˆ˜ì§] ë§‰ëŒ€ê·¸ë˜í”„ëŠ” [ì„¤ëª…]ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.

**ë°ì´í„° (ìˆœì„œëŒ€ë¡œ):**
- í•­ëª©1: ê°’1
- í•­ëª©2: ê°’2

**ì¸ì‚¬ì´íŠ¸:**
[ìµœëŒ€/ìµœì†Œê°’, íŒ¨í„´ ë“±]""",

            'table': """ì´ í‘œ(í…Œì´ë¸”)ë¥¼ ë¶„ì„í•˜ì„¸ìš”.

**í•„ìˆ˜ ì •ë³´:**
1. í‘œ ì œëª©
2. ì—´(ì»¬ëŸ¼) í—¤ë”
3. í–‰(ë¡œìš°) í—¤ë”
4. ëª¨ë“  ì…€ ë°ì´í„°
5. ë‹¨ìœ„

**ì¶œë ¥ í˜•ì‹:**
### [í‘œ ì œëª©]
ì´ í‘œëŠ” [ì„¤ëª…]ì…ë‹ˆë‹¤.

**êµ¬ì¡°:**
- ì—´: [ì»¬ëŸ¼1, ì»¬ëŸ¼2, ...]
- í–‰: [ë¡œìš°1, ë¡œìš°2, ...]

**ë°ì´í„°:**
| ì—´1 | ì—´2 | ì—´3 |
|-----|-----|-----|
| ê°’1 | ê°’2 | ê°’3 |

**ì¸ì‚¬ì´íŠ¸:**
[ì£¼ìš” ë°œê²¬ ì‚¬í•­]""",

            'map': """ì´ ì§€ë„ë¥¼ ë¶„ì„í•˜ì„¸ìš”.

**í•„ìˆ˜ ì •ë³´:**
1. ì§€ë„ ì œëª©
2. ëª¨ë“  ì§€ì—­ëª… (ë¹ ì§ì—†ì´)
3. ê° ì§€ì—­ì˜ ê°’
4. ë‹¨ìœ„
5. ìƒ‰ìƒ êµ¬ë¶„ ì˜ë¯¸

**ì¶œë ¥ í˜•ì‹:**
### [ì œëª©]
ì´ ì§€ë„ëŠ” [ì§€ì—­ë³„ ë¶„í¬]ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.

**ì§€ì—­ ë°ì´í„° (ëª¨ë‘ ë‚˜ì—´):**
- ì§€ì—­1: ê°’1
- ì§€ì—­2: ê°’2
- ì§€ì—­3: ê°’3
[ëª¨ë“  ì§€ì—­ í¬í•¨]

**ì¸ì‚¬ì´íŠ¸:**
[ê°€ì¥ ë†’ì€/ë‚®ì€ ì§€ì—­, ë¶„í¬ íŠ¹ì§•]

âš ï¸ ì£¼ì˜: ëª¨ë“  ì§€ì—­ì„ ë¹ ì§ì—†ì´ ì •í™•íˆ ê¸°ë¡í•˜ì„¸ìš”."""
        }
        
        return prompts.get(chart_type, StructuredPrompts.get_full_page_analysis_prompt())

    @staticmethod
    def get_validation_prompt(caption: str) -> str:
        """
        ìº¡ì…˜ í’ˆì§ˆ ê²€ì¦ìš© í”„ë¡¬í”„íŠ¸
        
        Args:
            caption: ê²€ì¦í•  ìº¡ì…˜ í…ìŠ¤íŠ¸
        """
        return f"""ë‹¤ìŒ ìº¡ì…˜ì„ ê²€ì¦í•˜ê³  ê°œì„ í•˜ì„¸ìš”:

```
{caption}
```

## ê²€ì¦ í•­ëª©:

1. **êµ¬ì¡° í™•ì¸:**
   - [ ] ì„¹ì…˜ ì œëª© ìˆìŒ
   - [ ] ì°¨íŠ¸ íƒ€ì… ëª…ì‹œë¨
   - [ ] ë°ì´í„°ê°€ ë¦¬ìŠ¤íŠ¸ í˜•ì‹ì„

2. **ì™„ì „ì„± í™•ì¸:**
   - [ ] ëª¨ë“  ë°ì´í„° í¬ì¸íŠ¸ í¬í•¨
   - [ ] ì§€ì—­ ë°ì´í„°ê°€ ìˆë‹¤ë©´ ëª¨ë‘ í¬í•¨
   - [ ] ì¸ì‚¬ì´íŠ¸ ì œê³µë¨

3. **ì •í™•ì„± í™•ì¸:**
   - [ ] ìˆ«ì í•©ê³„ê°€ 100% (ë¹„ìœ¨ì¸ ê²½ìš°)
   - [ ] ì§€ì—­ëª… ì •í™•í•¨
   - [ ] ë‹¨ìœ„ ëª…ì‹œë¨

## ê°œì„ ì´ í•„ìš”í•œ ê²½ìš°:

ê°œì„ ëœ ë²„ì „ì„ ì¶œë ¥í•˜ì„¸ìš”. ê°œì„ ì´ ë¶ˆí•„ìš”í•˜ë©´ "ê²€ì¦ ì™„ë£Œ"ë¼ê³ ë§Œ ì¶œë ¥í•˜ì„¸ìš”."""

    @staticmethod
    def build_prompt_with_context(
        element_type: str,
        page_number: int,
        total_pages: int,
        detected_regions: int = 0
    ) -> str:
        """
        ì»¨í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•œ í”„ë¡¬í”„íŠ¸ ìƒì„±
        
        Args:
            element_type: ì˜ˆìƒë˜ëŠ” ìš”ì†Œ íƒ€ì…
            page_number: í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸
            total_pages: ì „ì²´ í˜ì´ì§€ ìˆ˜
            detected_regions: ê°ì§€ëœ ì˜ì—­ ìˆ˜
        """
        base_prompt = StructuredPrompts.get_full_page_analysis_prompt()
        
        context = f"""
## ğŸ“„ ë¬¸ì„œ ì»¨í…ìŠ¤íŠ¸:

- **í˜ì´ì§€**: {page_number}/{total_pages}
- **ì˜ˆìƒ íƒ€ì…**: {element_type}
- **ê°ì§€ëœ ì˜ì—­**: {detected_regions}ê°œ

"""
        
        return context + base_prompt


# ì‚¬ìš© ì˜ˆì‹œ
if __name__ == '__main__':
    prompts = StructuredPrompts()
    
    # ì „ì²´ í˜ì´ì§€ ë¶„ì„
    print("=== ì „ì²´ í˜ì´ì§€ ë¶„ì„ í”„ë¡¬í”„íŠ¸ ===")
    print(prompts.get_full_page_analysis_prompt())
    
    print("\n" + "="*60 + "\n")
    
    # ì°¨íŠ¸ë³„ í”„ë¡¬í”„íŠ¸
    print("=== ì§€ë„ ë¶„ì„ í”„ë¡¬í”„íŠ¸ ===")
    print(prompts.get_chart_specific_prompt('map'))